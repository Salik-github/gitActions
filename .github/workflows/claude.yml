name: E2E Tests with Nay Agent

on:
  workflow_dispatch:                 # Manual run from UI
  push:                            # Trigger on push

jobs:
  use-playwright:
  
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Gemini Agent (free AI agent CLI)
        run: curl -fsSL https://gemini.dev/install.sh | bash

      - name: Install Playwright + Node
        run: |
          npm init -y
          npm install playwright @playwright/test
          npx playwright install --with-deps

      - name: Create required files/folders
        run: |
          mkdir -p screenshots playwright-report

      - name: Run Gemini Agent with prompt.md + 'run'
        run: |
          # Load system prompt from file, execute 'run' non-interactively
          gemini --model gemini-2.0-pro-exp \
                 --system "$(cat prompt.md)" \
                 --non-interactive \
                 "run"

      - name: Upload HTML report + screenshots + CSV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-and-screenshots
          path: |
            playwright-report/
            screenshots/
            *.csv
            test-results.*