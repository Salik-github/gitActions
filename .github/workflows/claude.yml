name: ðŸ“ Playwright Agent E2E Workflow

on:
  push:
    branches:
      - main
    paths:
      - 'project/prompt.md'
      # Add other files the agent might modify/use here

jobs:
  e2e_agent_test:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Node.js & Install Gemini CLI
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          run: npm install -g @google/gemini-cli

      # 3. Setup Playwright (Crucial step the agent relies on!)
      - name: 3. Install Playwright Dependencies
        # The agent is instructed to run Playwright, so we must install it and its browsers.
        run: |
          npm install playwright
          npx playwright install --with-deps

      - name: 4. Execute E2E Testing Agent (Combined Prompt)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Concatenate the instruction prompt with the execution command 'run'.
          AGENT_PROMPT="As an E2E Testing Agent, analyze the instructions in the attached Markdown file. Now, execute the command 'run' immediately to proceed with the Playwright test generation and execution as described in the file. @project/prompt.md\n\nrun"
          
          # We explicitly allow the agent to use the Shell and File tools for generating/running tests
          gemini \
            "${AGENT_PROMPT}" \
            --model gemini-2.5-flash \
            --output-format text \
            --allowed-tools "Shell,WriteFile,ReadFile" > AGENT_OUTPUT.md
          
          echo "--- Agent Action Log ---"
          cat AGENT_OUTPUT.md
          
      # ----------------------------------------------------
      # THE NEW STEP TO HANDLE THE REPORT
      # ----------------------------------------------------
      - name: 5. Upload Playwright HTML Report
        uses: actions/upload-artifact@v4
        # 'if: always()' ensures the report is uploaded even if the tests failed (Step 4 exited with an error)
        if: ${{ always() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 5 # How long to keep the report on GitHub