name: Playwright E2E with Gemini CLI Agent

on:
  workflow_dispatch:  # Manual trigger
  push:

jobs:
  e2e-tests:
  

    runs-on: ubuntu-latest
   

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI (official, free AI agent)
        run: |
          npm install -g @google/gemini-cli
          gemini --version  # Verify install

      - name: Install Playwright deps
        run: |
          npm init -y
          npm install playwright @playwright/test
          npx playwright install --with-deps

      - name: Setup folders
        run: mkdir -p screenshots playwright-report

      - name: Authenticate Gemini (using free API key secret)
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
          # Test auth (optional, for logging)
          gemini --model gemini-2.0-pro "Hello" --non-interactive

      - name: "Run Gemini Agent: Load prompt.md + execute 'run'"
        run: |
          # Pipe prompt.md as system prompt, run "run" non-interactively
          # (Gemini CLI will: launch browser, execute testcase.txt steps, screenshot fails, gen reports)
          cat prompt.md | gemini \
            --model gemini-2.0-pro \
            --system-prompt-from-stdin \
            --non-interactive \
            "run"

      - name: Upload reports & screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-playwright-reports
          path: |
            playwright-report/
            screenshots/
            *.csv
            test-results.*
          retention-days: 30
